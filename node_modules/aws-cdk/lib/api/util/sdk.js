"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const cxapi = require("@aws-cdk/cx-api");
const AWS = require("aws-sdk");
const child_process = require("child_process");
const fs = require("fs-extra");
const os = require("os");
const path = require("path");
const util = require("util");
const logging_1 = require("../../logging");
const plugin_1 = require("../../plugin");
const account_cache_1 = require("./account-cache");
const sdk_ini_file_1 = require("./sdk_ini_file");
/**
 * Source for SDK client objects
 *
 * Credentials are first obtained from the SDK defaults (using environment variables and the
 * ~/.aws/{config,credentials} files).
 *
 * If those don't suffice, a list of CredentialProviderSources is interrogated for access
 * to the requested account.
 */
class SDK {
    constructor(options = {}) {
        /**
         * Default retry options for SDK clients
         *
         * Biggest bottleneck is CloudFormation, with a 1tps call rate. We want to be
         * a little more tenacious than the defaults, and with a little more breathing
         * room between calls (defaults are {retries=3, base=100}).
         *
         * I've left this running in a tight loop for an hour and the throttle errors
         * haven't escaped the retry mechanism.
         */
        this.retryOptions = { maxRetries: 6, retryDelayOptions: { base: 300 } };
        this.profile = options.profile;
        const defaultCredentialProvider = makeCLICompatibleCredentialProvider(options.profile, options.ec2creds);
        // Find the package.json from the main toolkit
        const pkg = require.main.require('../package.json');
        AWS.config.update({
            customUserAgent: `${pkg.name}/${pkg.version}`
        });
        // https://aws.amazon.com/blogs/developer/using-the-aws-sdk-for-javascript-from-behind-a-proxy/
        if (options.proxyAddress === undefined) {
            options.proxyAddress = httpsProxyFromEnvironment();
        }
        if (options.proxyAddress) { // Ignore empty string on purpose
            logging_1.debug('Using proxy server: %s', options.proxyAddress);
            AWS.config.update({
                httpOptions: { agent: require('proxy-agent')(options.proxyAddress) }
            });
        }
        this.defaultAwsAccount = new DefaultAWSAccount(defaultCredentialProvider, getCLICompatibleDefaultRegionGetter(this.profile));
        this.credentialsCache = new CredentialsCache(this.defaultAwsAccount, defaultCredentialProvider);
    }
    async cloudFormation(account, region, mode) {
        const environment = await this.resolveEnvironment(account, region);
        return new AWS.CloudFormation({
            ...this.retryOptions,
            region: environment.region,
            credentials: await this.credentialsCache.get(environment.account, mode)
        });
    }
    async ec2(account, region, mode) {
        const environment = await this.resolveEnvironment(account, region);
        return new AWS.EC2({
            ...this.retryOptions,
            region: environment.region,
            credentials: await this.credentialsCache.get(environment.account, mode)
        });
    }
    async ssm(account, region, mode) {
        const environment = await this.resolveEnvironment(account, region);
        return new AWS.SSM({
            ...this.retryOptions,
            region: environment.region,
            credentials: await this.credentialsCache.get(environment.account, mode)
        });
    }
    async s3(account, region, mode) {
        const environment = await this.resolveEnvironment(account, region);
        return new AWS.S3({
            ...this.retryOptions,
            region: environment.region,
            credentials: await this.credentialsCache.get(environment.account, mode)
        });
    }
    async route53(account, region, mode) {
        const environment = await this.resolveEnvironment(account, region);
        return new AWS.Route53({
            ...this.retryOptions,
            region: environment.region,
            credentials: await this.credentialsCache.get(environment.account, mode),
        });
    }
    async ecr(account, region, mode) {
        const environment = await this.resolveEnvironment(account, region);
        return new AWS.ECR({
            ...this.retryOptions,
            region: environment.region,
            credentials: await this.credentialsCache.get(environment.account, mode)
        });
    }
    async defaultRegion() {
        return await getCLICompatibleDefaultRegionGetter(this.profile)();
    }
    defaultAccount() {
        return this.defaultAwsAccount.get();
    }
    async resolveEnvironment(account, region) {
        if (region === cxapi.UNKNOWN_REGION) {
            region = await this.defaultRegion();
        }
        if (account === cxapi.UNKNOWN_ACCOUNT) {
            account = await this.defaultAccount();
        }
        if (!region) {
            throw new Error(`AWS region must be configured either when you configure your CDK stack or through the environment`);
        }
        if (!account) {
            throw new Error(`Unable to resolve AWS account to use. It must be either configured when you define your CDK or through the environment`);
        }
        const environment = {
            region, account, name: cxapi.EnvironmentUtils.format(account, region)
        };
        return environment;
    }
}
exports.SDK = SDK;
/**
 * Cache for credential providers.
 *
 * Given an account and an operating mode (read or write) will return an
 * appropriate credential provider for credentials for the given account. The
 * credential provider will be cached so that multiple AWS clients for the same
 * environment will not make multiple network calls to obtain credentials.
 *
 * Will use default credentials if they are for the right account; otherwise,
 * all loaded credential provider plugins will be tried to obtain credentials
 * for the given account.
 */
class CredentialsCache {
    constructor(defaultAwsAccount, defaultCredentialProvider) {
        this.defaultAwsAccount = defaultAwsAccount;
        this.defaultCredentialProvider = defaultCredentialProvider;
        this.cache = {};
    }
    async get(awsAccountId, mode) {
        const key = `${awsAccountId}-${mode}`;
        if (!(key in this.cache)) {
            this.cache[key] = await this.getCredentials(awsAccountId, mode);
        }
        return this.cache[key];
    }
    async getCredentials(awsAccountId, mode) {
        // If requested account is undefined or equal to default account, use default credentials provider.
        // (Note that we ignore the mode in this case, if you preloaded credentials they better be correct!)
        const defaultAccount = await this.defaultAwsAccount.get();
        if (!awsAccountId || awsAccountId === defaultAccount || awsAccountId === cxapi.UNKNOWN_ACCOUNT) {
            logging_1.debug(`Using default AWS SDK credentials for account ${awsAccountId}`);
            // CredentialProviderChain extends Credentials, but that is a lie.
            // https://github.com/aws/aws-sdk-js/issues/2235
            // Call resolve() instead.
            return (await this.defaultCredentialProvider).resolvePromise();
        }
        const triedSources = [];
        // Otherwise, inspect the various credential sources we have
        for (const source of plugin_1.PluginHost.instance.credentialProviderSources) {
            if (!(await source.isAvailable())) {
                logging_1.debug('Credentials source %s is not available, ignoring it.', source.name);
                continue;
            }
            triedSources.push(source);
            if (!(await source.canProvideCredentials(awsAccountId))) {
                continue;
            }
            logging_1.debug(`Using ${source.name} credentials for account ${awsAccountId}`);
            const providerOrCreds = await source.getProvider(awsAccountId, mode);
            // Backwards compatibility: if the plugin returns a ProviderChain, resolve that chain.
            // Otherwise it must have returned credentials.
            if (providerOrCreds.resolvePromise) {
                return await providerOrCreds.resolvePromise();
            }
            return providerOrCreds;
        }
        const sourceNames = ['default credentials'].concat(triedSources.map(s => s.name)).join(', ');
        throw new Error(`Need to perform AWS calls for account ${awsAccountId}, but no credentials found. Tried: ${sourceNames}.`);
    }
}
/**
 * Class to retrieve the account for default credentials and cache it.
 *
 * Uses the default credentials provider to obtain credentials (if available),
 * and uses those credentials to call STS to request the current account ID.
 *
 * The credentials => accountId lookup is cached on disk, since it's
 * guaranteed that igven access key will always remain for the same account.
 */
class DefaultAWSAccount {
    constructor(defaultCredentialsProvider, region) {
        this.defaultCredentialsProvider = defaultCredentialsProvider;
        this.region = region;
        this.defaultAccountFetched = false;
        this.defaultAccountId = undefined;
        this.accountCache = new account_cache_1.AccountAccessKeyCache();
    }
    /**
     * Return the default account
     */
    async get() {
        if (!this.defaultAccountFetched) {
            this.defaultAccountId = await this.lookupDefaultAccount();
            this.defaultAccountFetched = true;
        }
        return this.defaultAccountId;
    }
    async lookupDefaultAccount() {
        try {
            // There just is *NO* way to do AssumeRole credentials as long as AWS_SDK_LOAD_CONFIG is not set. The SDK
            // crash if the file does not exist though. So set the environment variable if we can find that file.
            await setConfigVariable();
            logging_1.debug('Resolving default credentials');
            const credentialProvider = await this.defaultCredentialsProvider;
            const creds = await credentialProvider.resolvePromise();
            const accessKeyId = creds.accessKeyId;
            if (!accessKeyId) {
                throw new Error('Unable to resolve AWS credentials (setup with "aws configure")');
            }
            const accountId = await this.accountCache.fetch(creds.accessKeyId, async () => {
                // if we don't have one, resolve from STS and store in cache.
                logging_1.debug('Looking up default account ID from STS');
                const result = await new AWS.STS({ credentials: creds, region: await this.region() }).getCallerIdentity().promise();
                const aid = result.Account;
                if (!aid) {
                    logging_1.debug('STS didn\'t return an account ID');
                    return undefined;
                }
                logging_1.debug('Default account ID:', aid);
                return aid;
            });
            return accountId;
        }
        catch (e) {
            logging_1.debug('Unable to determine the default AWS account (did you configure "aws configure"?):', e);
            return undefined;
        }
    }
}
/**
 * Build an AWS CLI-compatible credential chain provider
 *
 * This is similar to the default credential provider chain created by the SDK
 * except it also accepts the profile argument in the constructor (not just from
 * the environment).
 *
 * To mimic the AWS CLI behavior:
 *
 * - we default to ~/.aws/credentials if environment variable for credentials
 * file location is not given (SDK expects explicit environment variable with name).
 * - AWS_DEFAULT_PROFILE is also inspected for profile name (not just AWS_PROFILE).
 */
async function makeCLICompatibleCredentialProvider(profile, ec2creds) {
    profile = profile || process.env.AWS_PROFILE || process.env.AWS_DEFAULT_PROFILE || 'default';
    // Need to construct filename ourselves, without appropriate environment variables
    // no defaults used by JS SDK.
    const filename = process.env.AWS_SHARED_CREDENTIALS_FILE || path.join(os.homedir(), '.aws', 'credentials');
    const sources = [
        () => new AWS.EnvironmentCredentials('AWS'),
        () => new AWS.EnvironmentCredentials('AMAZON'),
    ];
    if (fs.pathExists(filename)) {
        sources.push(() => new AWS.SharedIniFileCredentials({ profile, filename }));
    }
    if (hasEcsCredentials()) {
        sources.push(() => new AWS.ECSCredentials());
    }
    else {
        // else if: don't get EC2 creds if we should have gotten ECS creds--ECS instances also
        // run on EC2 boxes but the creds represent something different. Same behavior as
        // upstream code.
        if (ec2creds === undefined) {
            ec2creds = await hasEc2Credentials();
        }
        if (ec2creds) {
            sources.push(() => new AWS.EC2MetadataCredentials());
        }
    }
    return new AWS.CredentialProviderChain(sources);
}
/**
 * Return the default region in a CLI-compatible way
 *
 * Mostly copied from node_loader.js, but with the following differences:
 *
 * - Takes a runtime profile name to load the region from, not just based on environment
 *   variables at process start.
 * - We have needed to create a local copy of the SharedIniFile class because the
 *   implementation in 'aws-sdk' is private (and the default use of it in the
 *   SDK does not allow us to specify a profile at runtime).
 * - AWS_DEFAULT_PROFILE and AWS_DEFAULT_REGION are also used as environment
 *   variables to be used to determine the region.
 *
 * Returns a function that can be invoked to retrieve the actual region value
 * (used to be just a promise, but that would lead to firing off a failing
 * operation and if it was never awaited NodeJS would complain).
 */
function getCLICompatibleDefaultRegionGetter(profile) {
    let retrieved = false;
    let region;
    return async () => {
        if (!retrieved) {
            profile = profile || process.env.AWS_PROFILE || process.env.AWS_DEFAULT_PROFILE || 'default';
            // Defaults inside constructor
            const toCheck = [
                { filename: process.env.AWS_SHARED_CREDENTIALS_FILE },
                { isConfig: true, filename: process.env.AWS_CONFIG_FILE },
            ];
            region = process.env.AWS_REGION || process.env.AMAZON_REGION ||
                process.env.AWS_DEFAULT_REGION || process.env.AMAZON_DEFAULT_REGION;
            while (!region && toCheck.length > 0) {
                const configFile = new sdk_ini_file_1.SharedIniFile(toCheck.shift());
                const section = await configFile.getProfile(profile);
                region = section && section.region;
            }
            if (!region) {
                const usedProfile = !profile ? '' : ` (profile: "${profile}")`;
                logging_1.debug(`Unable to determine AWS region from environment or AWS configuration${usedProfile}`);
            }
            retrieved = true;
        }
        return region;
    };
}
/**
 * Find and return the configured HTTPS proxy address
 */
function httpsProxyFromEnvironment() {
    if (process.env.https_proxy) {
        return process.env.https_proxy;
    }
    if (process.env.HTTPS_PROXY) {
        return process.env.HTTPS_PROXY;
    }
    return undefined;
}
/**
 * Return whether it looks like we'll have ECS credentials available
 */
function hasEcsCredentials() {
    return AWS.ECSCredentials.prototype.isConfiguredForEcsCredentials();
}
/**
 * Return whether we're on an EC2 instance
 */
async function hasEc2Credentials() {
    logging_1.debug("Determining whether we're on an EC2 instance.");
    let instance = false;
    if (process.platform === 'win32') {
        // https://docs.aws.amazon.com/AWSEC2/latest/WindowsGuide/identify_ec2_instances.html
        const result = await util.promisify(child_process.exec)('wmic path win32_computersystemproduct get uuid', { encoding: 'utf-8' });
        // output looks like
        //  UUID
        //  EC2AE145-D1DC-13B2-94ED-01234ABCDEF
        const lines = result.stdout.toString().split('\n');
        instance = lines.some(x => matchesRegex(/^ec2/i, x));
    }
    else {
        // https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/identify_ec2_instances.html
        const files = [
            // This recognizes the Xen hypervisor based instances (pre-5th gen)
            ['/sys/hypervisor/uuid', /^ec2/i],
            // This recognizes the new Hypervisor (5th-gen instances and higher)
            // Can't use the advertised file '/sys/devices/virtual/dmi/id/product_uuid' because it requires root to read.
            // Instead, sys_vendor contains something like 'Amazon EC2'.
            ['/sys/devices/virtual/dmi/id/sys_vendor', /ec2/i],
        ];
        for (const [file, re] of files) {
            if (matchesRegex(re, await readIfPossible(file))) {
                instance = true;
                break;
            }
        }
    }
    logging_1.debug(instance ? 'Looks like EC2 instance.' : 'Does not look like EC2 instance.');
    return instance;
}
async function setConfigVariable() {
    const homeDir = process.env.HOME || process.env.USERPROFILE
        || (process.env.HOMEPATH ? ((process.env.HOMEDRIVE || 'C:/') + process.env.HOMEPATH) : null) || os.homedir();
    if (await fs.pathExists(path.resolve(homeDir, '.aws', 'config'))) {
        process.env.AWS_SDK_LOAD_CONFIG = '1';
    }
}
async function readIfPossible(filename) {
    try {
        if (!await fs.pathExists(filename)) {
            return undefined;
        }
        return fs.readFile(filename, { encoding: 'utf-8' });
    }
    catch (e) {
        logging_1.debug(e);
        return undefined;
    }
}
function matchesRegex(re, s) {
    return s !== undefined && re.exec(s) !== null;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2RrLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsic2RrLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEseUNBQTBDO0FBQzFDLCtCQUFnQztBQUNoQywrQ0FBZ0Q7QUFDaEQsK0JBQWdDO0FBQ2hDLHlCQUEwQjtBQUMxQiw2QkFBOEI7QUFDOUIsNkJBQThCO0FBQzlCLDJDQUFzQztBQUN0Qyx5Q0FBMEM7QUFFMUMsbURBQXdEO0FBQ3hELGlEQUErQztBQTJCL0M7Ozs7Ozs7O0dBUUc7QUFDSCxNQUFhLEdBQUc7SUFpQmQsWUFBWSxVQUFzQixFQUFFO1FBWnBDOzs7Ozs7Ozs7V0FTRztRQUNjLGlCQUFZLEdBQUcsRUFBRSxVQUFVLEVBQUUsQ0FBQyxFQUFFLGlCQUFpQixFQUFFLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxFQUFDLENBQUM7UUFHakYsSUFBSSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDO1FBRS9CLE1BQU0seUJBQXlCLEdBQUcsbUNBQW1DLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7UUFFekcsOENBQThDO1FBQzlDLE1BQU0sR0FBRyxHQUFJLE9BQU8sQ0FBQyxJQUFZLENBQUMsT0FBTyxDQUFDLGlCQUFpQixDQUFDLENBQUM7UUFDN0QsR0FBRyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUM7WUFDZCxlQUFlLEVBQUUsR0FBRyxHQUFHLENBQUMsSUFBSSxJQUFJLEdBQUcsQ0FBQyxPQUFPLEVBQUU7U0FDaEQsQ0FBQyxDQUFDO1FBRUgsK0ZBQStGO1FBQy9GLElBQUksT0FBTyxDQUFDLFlBQVksS0FBSyxTQUFTLEVBQUU7WUFDdEMsT0FBTyxDQUFDLFlBQVksR0FBRyx5QkFBeUIsRUFBRSxDQUFDO1NBQ3BEO1FBQ0QsSUFBSSxPQUFPLENBQUMsWUFBWSxFQUFFLEVBQUUsaUNBQWlDO1lBQzNELGVBQUssQ0FBQyx3QkFBd0IsRUFBRSxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUM7WUFDdEQsR0FBRyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUM7Z0JBQ2hCLFdBQVcsRUFBRSxFQUFFLEtBQUssRUFBRSxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxFQUFFO2FBQ3JFLENBQUMsQ0FBQztTQUNKO1FBRUQsSUFBSSxDQUFDLGlCQUFpQixHQUFHLElBQUksaUJBQWlCLENBQUMseUJBQXlCLEVBQUUsbUNBQW1DLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7UUFDN0gsSUFBSSxDQUFDLGdCQUFnQixHQUFHLElBQUksZ0JBQWdCLENBQUMsSUFBSSxDQUFDLGlCQUFpQixFQUFFLHlCQUF5QixDQUFDLENBQUM7SUFDbEcsQ0FBQztJQUVNLEtBQUssQ0FBQyxjQUFjLENBQUMsT0FBMkIsRUFBRSxNQUEwQixFQUFFLElBQVU7UUFDN0YsTUFBTSxXQUFXLEdBQUcsTUFBTSxJQUFJLENBQUMsa0JBQWtCLENBQUMsT0FBTyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQ25FLE9BQU8sSUFBSSxHQUFHLENBQUMsY0FBYyxDQUFDO1lBQzVCLEdBQUcsSUFBSSxDQUFDLFlBQVk7WUFDcEIsTUFBTSxFQUFFLFdBQVcsQ0FBQyxNQUFNO1lBQzFCLFdBQVcsRUFBRSxNQUFNLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUM7U0FDeEUsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVNLEtBQUssQ0FBQyxHQUFHLENBQUMsT0FBMkIsRUFBRSxNQUEwQixFQUFFLElBQVU7UUFDbEYsTUFBTSxXQUFXLEdBQUcsTUFBTSxJQUFJLENBQUMsa0JBQWtCLENBQUMsT0FBTyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQ25FLE9BQU8sSUFBSSxHQUFHLENBQUMsR0FBRyxDQUFDO1lBQ2pCLEdBQUcsSUFBSSxDQUFDLFlBQVk7WUFDcEIsTUFBTSxFQUFFLFdBQVcsQ0FBQyxNQUFNO1lBQzFCLFdBQVcsRUFBRSxNQUFNLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUM7U0FDeEUsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVNLEtBQUssQ0FBQyxHQUFHLENBQUMsT0FBMkIsRUFBRSxNQUEwQixFQUFFLElBQVU7UUFDbEYsTUFBTSxXQUFXLEdBQUcsTUFBTSxJQUFJLENBQUMsa0JBQWtCLENBQUMsT0FBTyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQ25FLE9BQU8sSUFBSSxHQUFHLENBQUMsR0FBRyxDQUFDO1lBQ2pCLEdBQUcsSUFBSSxDQUFDLFlBQVk7WUFDcEIsTUFBTSxFQUFFLFdBQVcsQ0FBQyxNQUFNO1lBQzFCLFdBQVcsRUFBRSxNQUFNLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUM7U0FDeEUsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVNLEtBQUssQ0FBQyxFQUFFLENBQUMsT0FBMkIsRUFBRSxNQUEwQixFQUFFLElBQVU7UUFDakYsTUFBTSxXQUFXLEdBQUcsTUFBTSxJQUFJLENBQUMsa0JBQWtCLENBQUMsT0FBTyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQ25FLE9BQU8sSUFBSSxHQUFHLENBQUMsRUFBRSxDQUFDO1lBQ2hCLEdBQUcsSUFBSSxDQUFDLFlBQVk7WUFDcEIsTUFBTSxFQUFFLFdBQVcsQ0FBQyxNQUFNO1lBQzFCLFdBQVcsRUFBRSxNQUFNLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUM7U0FDeEUsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVNLEtBQUssQ0FBQyxPQUFPLENBQUMsT0FBMkIsRUFBRSxNQUEwQixFQUFFLElBQVU7UUFDdEYsTUFBTSxXQUFXLEdBQUcsTUFBTSxJQUFJLENBQUMsa0JBQWtCLENBQUMsT0FBTyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQ25FLE9BQU8sSUFBSSxHQUFHLENBQUMsT0FBTyxDQUFDO1lBQ3JCLEdBQUcsSUFBSSxDQUFDLFlBQVk7WUFDcEIsTUFBTSxFQUFFLFdBQVcsQ0FBQyxNQUFNO1lBQzFCLFdBQVcsRUFBRSxNQUFNLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUM7U0FDeEUsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVNLEtBQUssQ0FBQyxHQUFHLENBQUMsT0FBMkIsRUFBRSxNQUEwQixFQUFFLElBQVU7UUFDbEYsTUFBTSxXQUFXLEdBQUcsTUFBTSxJQUFJLENBQUMsa0JBQWtCLENBQUMsT0FBTyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQ25FLE9BQU8sSUFBSSxHQUFHLENBQUMsR0FBRyxDQUFDO1lBQ2pCLEdBQUcsSUFBSSxDQUFDLFlBQVk7WUFDcEIsTUFBTSxFQUFFLFdBQVcsQ0FBQyxNQUFNO1lBQzFCLFdBQVcsRUFBRSxNQUFNLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUM7U0FDeEUsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVNLEtBQUssQ0FBQyxhQUFhO1FBQ3hCLE9BQU8sTUFBTSxtQ0FBbUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQztJQUNuRSxDQUFDO0lBRU0sY0FBYztRQUNuQixPQUFPLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxHQUFHLEVBQUUsQ0FBQztJQUN0QyxDQUFDO0lBRU8sS0FBSyxDQUFDLGtCQUFrQixDQUFDLE9BQTJCLEVBQUUsTUFBMEI7UUFDdEYsSUFBSSxNQUFNLEtBQUssS0FBSyxDQUFDLGNBQWMsRUFBRTtZQUNuQyxNQUFNLEdBQUcsTUFBTSxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7U0FDckM7UUFFRCxJQUFJLE9BQU8sS0FBSyxLQUFLLENBQUMsZUFBZSxFQUFFO1lBQ3JDLE9BQU8sR0FBRyxNQUFNLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztTQUN2QztRQUVELElBQUksQ0FBQyxNQUFNLEVBQUU7WUFDWCxNQUFNLElBQUksS0FBSyxDQUFDLG1HQUFtRyxDQUFDLENBQUM7U0FDdEg7UUFFRCxJQUFJLENBQUMsT0FBTyxFQUFFO1lBQ1osTUFBTSxJQUFJLEtBQUssQ0FBQyx3SEFBd0gsQ0FBQyxDQUFDO1NBQzNJO1FBRUQsTUFBTSxXQUFXLEdBQXNCO1lBQ3JDLE1BQU0sRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFLE1BQU0sQ0FBQztTQUN0RSxDQUFDO1FBRUYsT0FBTyxXQUFXLENBQUM7SUFDckIsQ0FBQztDQUVGO0FBaklELGtCQWlJQztBQUVEOzs7Ozs7Ozs7OztHQVdHO0FBQ0gsTUFBTSxnQkFBZ0I7SUFHcEIsWUFDbUIsaUJBQW9DLEVBQ3BDLHlCQUErRDtRQUQvRCxzQkFBaUIsR0FBakIsaUJBQWlCLENBQW1CO1FBQ3BDLDhCQUF5QixHQUF6Qix5QkFBeUIsQ0FBc0M7UUFKakUsVUFBSyxHQUFxQyxFQUFFLENBQUM7SUFLOUQsQ0FBQztJQUVNLEtBQUssQ0FBQyxHQUFHLENBQUMsWUFBZ0MsRUFBRSxJQUFVO1FBQzNELE1BQU0sR0FBRyxHQUFHLEdBQUcsWUFBWSxJQUFJLElBQUksRUFBRSxDQUFDO1FBQ3RDLElBQUksQ0FBQyxDQUFDLEdBQUcsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUU7WUFDeEIsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsR0FBRyxNQUFNLElBQUksQ0FBQyxjQUFjLENBQUMsWUFBWSxFQUFFLElBQUksQ0FBQyxDQUFDO1NBQ2pFO1FBQ0QsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3pCLENBQUM7SUFFTyxLQUFLLENBQUMsY0FBYyxDQUFDLFlBQWdDLEVBQUUsSUFBVTtRQUN2RSxtR0FBbUc7UUFDbkcsb0dBQW9HO1FBQ3BHLE1BQU0sY0FBYyxHQUFHLE1BQU0sSUFBSSxDQUFDLGlCQUFpQixDQUFDLEdBQUcsRUFBRSxDQUFDO1FBQzFELElBQUksQ0FBQyxZQUFZLElBQUksWUFBWSxLQUFLLGNBQWMsSUFBSSxZQUFZLEtBQUssS0FBSyxDQUFDLGVBQWUsRUFBRTtZQUM5RixlQUFLLENBQUMsaURBQWlELFlBQVksRUFBRSxDQUFDLENBQUM7WUFFdkUsa0VBQWtFO1lBQ2xFLGdEQUFnRDtZQUNoRCwwQkFBMEI7WUFDMUIsT0FBTyxDQUFDLE1BQU0sSUFBSSxDQUFDLHlCQUF5QixDQUFDLENBQUMsY0FBYyxFQUFFLENBQUM7U0FDaEU7UUFFRCxNQUFNLFlBQVksR0FBK0IsRUFBRSxDQUFDO1FBQ3BELDREQUE0RDtRQUM1RCxLQUFLLE1BQU0sTUFBTSxJQUFJLG1CQUFVLENBQUMsUUFBUSxDQUFDLHlCQUF5QixFQUFFO1lBQ2xFLElBQUksQ0FBQyxDQUFDLE1BQU0sTUFBTSxDQUFDLFdBQVcsRUFBRSxDQUFDLEVBQUU7Z0JBQ2pDLGVBQUssQ0FBQyxzREFBc0QsRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQzNFLFNBQVM7YUFDVjtZQUNELFlBQVksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDMUIsSUFBSSxDQUFDLENBQUMsTUFBTSxNQUFNLENBQUMscUJBQXFCLENBQUMsWUFBWSxDQUFDLENBQUMsRUFBRTtnQkFBRSxTQUFTO2FBQUU7WUFDdEUsZUFBSyxDQUFDLFNBQVMsTUFBTSxDQUFDLElBQUksNEJBQTRCLFlBQVksRUFBRSxDQUFDLENBQUM7WUFDdEUsTUFBTSxlQUFlLEdBQUcsTUFBTSxNQUFNLENBQUMsV0FBVyxDQUFDLFlBQVksRUFBRSxJQUFJLENBQUMsQ0FBQztZQUVyRSxzRkFBc0Y7WUFDdEYsK0NBQStDO1lBQy9DLElBQUssZUFBdUIsQ0FBQyxjQUFjLEVBQUU7Z0JBQzNDLE9BQU8sTUFBTyxlQUF1QixDQUFDLGNBQWMsRUFBRSxDQUFDO2FBQ3hEO1lBQ0QsT0FBTyxlQUFlLENBQUM7U0FDeEI7UUFDRCxNQUFNLFdBQVcsR0FBRyxDQUFDLHFCQUFxQixDQUFDLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDN0YsTUFBTSxJQUFJLEtBQUssQ0FBQyx5Q0FBeUMsWUFBWSxzQ0FBc0MsV0FBVyxHQUFHLENBQUMsQ0FBQztJQUM3SCxDQUFDO0NBQ0Y7QUFFRDs7Ozs7Ozs7R0FRRztBQUNILE1BQU0saUJBQWlCO0lBS3JCLFlBQ3FCLDBCQUFnRSxFQUNoRSxNQUF5QztRQUR6QywrQkFBMEIsR0FBMUIsMEJBQTBCLENBQXNDO1FBQ2hFLFdBQU0sR0FBTixNQUFNLENBQW1DO1FBTnRELDBCQUFxQixHQUFHLEtBQUssQ0FBQztRQUM5QixxQkFBZ0IsR0FBWSxTQUFTLENBQUM7UUFDN0IsaUJBQVksR0FBRyxJQUFJLHFDQUFxQixFQUFFLENBQUM7SUFLNUQsQ0FBQztJQUVEOztPQUVHO0lBQ0ksS0FBSyxDQUFDLEdBQUc7UUFDZCxJQUFJLENBQUMsSUFBSSxDQUFDLHFCQUFxQixFQUFFO1lBQy9CLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxNQUFNLElBQUksQ0FBQyxvQkFBb0IsRUFBRSxDQUFDO1lBQzFELElBQUksQ0FBQyxxQkFBcUIsR0FBRyxJQUFJLENBQUM7U0FDbkM7UUFDRCxPQUFPLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQztJQUMvQixDQUFDO0lBRU8sS0FBSyxDQUFDLG9CQUFvQjtRQUNoQyxJQUFJO1lBQ0YseUdBQXlHO1lBQ3pHLHFHQUFxRztZQUNyRyxNQUFNLGlCQUFpQixFQUFFLENBQUM7WUFFMUIsZUFBSyxDQUFDLCtCQUErQixDQUFDLENBQUM7WUFDdkMsTUFBTSxrQkFBa0IsR0FBRyxNQUFNLElBQUksQ0FBQywwQkFBMEIsQ0FBQztZQUNqRSxNQUFNLEtBQUssR0FBRyxNQUFNLGtCQUFrQixDQUFDLGNBQWMsRUFBRSxDQUFDO1lBRXhELE1BQU0sV0FBVyxHQUFHLEtBQUssQ0FBQyxXQUFXLENBQUM7WUFDdEMsSUFBSSxDQUFDLFdBQVcsRUFBRTtnQkFDaEIsTUFBTSxJQUFJLEtBQUssQ0FBQyxnRUFBZ0UsQ0FBQyxDQUFDO2FBQ25GO1lBRUQsTUFBTSxTQUFTLEdBQUcsTUFBTSxJQUFJLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsV0FBVyxFQUFFLEtBQUssSUFBSSxFQUFFO2dCQUM1RSw2REFBNkQ7Z0JBQzdELGVBQUssQ0FBQyx3Q0FBd0MsQ0FBQyxDQUFDO2dCQUNoRCxNQUFNLE1BQU0sR0FBRyxNQUFNLElBQUksR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFFLFdBQVcsRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLE1BQU0sSUFBSSxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsQ0FBQyxpQkFBaUIsRUFBRSxDQUFDLE9BQU8sRUFBRSxDQUFDO2dCQUNwSCxNQUFNLEdBQUcsR0FBRyxNQUFNLENBQUMsT0FBTyxDQUFDO2dCQUMzQixJQUFJLENBQUMsR0FBRyxFQUFFO29CQUNSLGVBQUssQ0FBQyxrQ0FBa0MsQ0FBQyxDQUFDO29CQUMxQyxPQUFPLFNBQVMsQ0FBQztpQkFDbEI7Z0JBQ0QsZUFBSyxDQUFDLHFCQUFxQixFQUFFLEdBQUcsQ0FBQyxDQUFDO2dCQUNsQyxPQUFPLEdBQUcsQ0FBQztZQUNiLENBQUMsQ0FBQyxDQUFDO1lBRUgsT0FBTyxTQUFTLENBQUM7U0FDbEI7UUFBQyxPQUFPLENBQUMsRUFBRTtZQUNWLGVBQUssQ0FBQyxtRkFBbUYsRUFBRSxDQUFDLENBQUMsQ0FBQztZQUM5RixPQUFPLFNBQVMsQ0FBQztTQUNsQjtJQUNILENBQUM7Q0FDRjtBQUVEOzs7Ozs7Ozs7Ozs7R0FZRztBQUNILEtBQUssVUFBVSxtQ0FBbUMsQ0FBQyxPQUEyQixFQUFFLFFBQTZCO0lBQzNHLE9BQU8sR0FBRyxPQUFPLElBQUksT0FBTyxDQUFDLEdBQUcsQ0FBQyxXQUFXLElBQUksT0FBTyxDQUFDLEdBQUcsQ0FBQyxtQkFBbUIsSUFBSSxTQUFTLENBQUM7SUFFN0Ysa0ZBQWtGO0lBQ2xGLDhCQUE4QjtJQUM5QixNQUFNLFFBQVEsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLDJCQUEyQixJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSxFQUFFLE1BQU0sRUFBRSxhQUFhLENBQUMsQ0FBQztJQUUzRyxNQUFNLE9BQU8sR0FBRztRQUNkLEdBQUcsRUFBRSxDQUFDLElBQUksR0FBRyxDQUFDLHNCQUFzQixDQUFDLEtBQUssQ0FBQztRQUMzQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxzQkFBc0IsQ0FBQyxRQUFRLENBQUM7S0FDL0MsQ0FBQztJQUNGLElBQUksRUFBRSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsRUFBRTtRQUMzQixPQUFPLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksR0FBRyxDQUFDLHdCQUF3QixDQUFDLEVBQUUsT0FBTyxFQUFFLFFBQVEsRUFBRSxDQUFDLENBQUMsQ0FBQztLQUM3RTtJQUVELElBQUksaUJBQWlCLEVBQUUsRUFBRTtRQUN2QixPQUFPLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksR0FBRyxDQUFDLGNBQWMsRUFBRSxDQUFDLENBQUM7S0FDOUM7U0FBTTtRQUNMLHNGQUFzRjtRQUN0RixpRkFBaUY7UUFDakYsaUJBQWlCO1FBRWpCLElBQUksUUFBUSxLQUFLLFNBQVMsRUFBRTtZQUFFLFFBQVEsR0FBRyxNQUFNLGlCQUFpQixFQUFFLENBQUM7U0FBRTtRQUVyRSxJQUFJLFFBQVEsRUFBRTtZQUNaLE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxHQUFHLENBQUMsc0JBQXNCLEVBQUUsQ0FBQyxDQUFDO1NBQ3REO0tBQ0Y7SUFFRCxPQUFPLElBQUksR0FBRyxDQUFDLHVCQUF1QixDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBQ2xELENBQUM7QUFFRDs7Ozs7Ozs7Ozs7Ozs7OztHQWdCRztBQUNILFNBQVMsbUNBQW1DLENBQUMsT0FBMkI7SUFDdEUsSUFBSSxTQUFTLEdBQUcsS0FBSyxDQUFDO0lBQ3RCLElBQUksTUFBMEIsQ0FBQztJQUMvQixPQUFPLEtBQUssSUFBSSxFQUFFO1FBQ2hCLElBQUksQ0FBQyxTQUFTLEVBQUU7WUFDZCxPQUFPLEdBQUcsT0FBTyxJQUFJLE9BQU8sQ0FBQyxHQUFHLENBQUMsV0FBVyxJQUFJLE9BQU8sQ0FBQyxHQUFHLENBQUMsbUJBQW1CLElBQUksU0FBUyxDQUFDO1lBRTdGLDhCQUE4QjtZQUM5QixNQUFNLE9BQU8sR0FBRztnQkFDZCxFQUFDLFFBQVEsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLDJCQUEyQixFQUFFO2dCQUNwRCxFQUFDLFFBQVEsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsZUFBZSxFQUFDO2FBQ3hELENBQUM7WUFFRixNQUFNLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLElBQUksT0FBTyxDQUFDLEdBQUcsQ0FBQyxhQUFhO2dCQUMxRCxPQUFPLENBQUMsR0FBRyxDQUFDLGtCQUFrQixJQUFJLE9BQU8sQ0FBQyxHQUFHLENBQUMscUJBQXFCLENBQUM7WUFFdEUsT0FBTyxDQUFDLE1BQU0sSUFBSSxPQUFPLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtnQkFDcEMsTUFBTSxVQUFVLEdBQUcsSUFBSSw0QkFBYSxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDO2dCQUN0RCxNQUFNLE9BQU8sR0FBRyxNQUFNLFVBQVUsQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLENBQUM7Z0JBQ3JELE1BQU0sR0FBRyxPQUFPLElBQUksT0FBTyxDQUFDLE1BQU0sQ0FBQzthQUNwQztZQUVELElBQUksQ0FBQyxNQUFNLEVBQUU7Z0JBQ1gsTUFBTSxXQUFXLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsZUFBZSxPQUFPLElBQUksQ0FBQztnQkFDL0QsZUFBSyxDQUFDLHVFQUF1RSxXQUFXLEVBQUUsQ0FBQyxDQUFDO2FBQzdGO1lBRUQsU0FBUyxHQUFHLElBQUksQ0FBQztTQUNsQjtRQUVELE9BQU8sTUFBTSxDQUFDO0lBQ2hCLENBQUMsQ0FBQztBQUNKLENBQUM7QUFFRDs7R0FFRztBQUNILFNBQVMseUJBQXlCO0lBQ2hDLElBQUksT0FBTyxDQUFDLEdBQUcsQ0FBQyxXQUFXLEVBQUU7UUFDM0IsT0FBTyxPQUFPLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQztLQUNoQztJQUNELElBQUksT0FBTyxDQUFDLEdBQUcsQ0FBQyxXQUFXLEVBQUU7UUFDM0IsT0FBTyxPQUFPLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQztLQUNoQztJQUNELE9BQU8sU0FBUyxDQUFDO0FBQ25CLENBQUM7QUFFRDs7R0FFRztBQUNILFNBQVMsaUJBQWlCO0lBQ3hCLE9BQVEsR0FBRyxDQUFDLGNBQWMsQ0FBQyxTQUFpQixDQUFDLDZCQUE2QixFQUFFLENBQUM7QUFDL0UsQ0FBQztBQUVEOztHQUVHO0FBQ0gsS0FBSyxVQUFVLGlCQUFpQjtJQUM5QixlQUFLLENBQUMsK0NBQStDLENBQUMsQ0FBQztJQUV2RCxJQUFJLFFBQVEsR0FBRyxLQUFLLENBQUM7SUFDckIsSUFBSSxPQUFPLENBQUMsUUFBUSxLQUFLLE9BQU8sRUFBRTtRQUNoQyxxRkFBcUY7UUFDckYsTUFBTSxNQUFNLEdBQUcsTUFBTSxJQUFJLENBQUMsU0FBUyxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxnREFBZ0QsRUFBRSxFQUFFLFFBQVEsRUFBRSxPQUFPLEVBQUUsQ0FBQyxDQUFDO1FBQ2pJLG9CQUFvQjtRQUNwQixRQUFRO1FBQ1IsdUNBQXVDO1FBQ3ZDLE1BQU0sS0FBSyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsUUFBUSxFQUFFLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ25ELFFBQVEsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsWUFBWSxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO0tBQ3REO1NBQU07UUFDTCxrRkFBa0Y7UUFDbEYsTUFBTSxLQUFLLEdBQTRCO1lBQ3JDLG1FQUFtRTtZQUNuRSxDQUFDLHNCQUFzQixFQUFFLE9BQU8sQ0FBQztZQUVqQyxvRUFBb0U7WUFDcEUsNkdBQTZHO1lBQzdHLDREQUE0RDtZQUM1RCxDQUFDLHdDQUF3QyxFQUFFLE1BQU0sQ0FBQztTQUNuRCxDQUFDO1FBQ0YsS0FBSyxNQUFNLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxJQUFJLEtBQUssRUFBRTtZQUM5QixJQUFJLFlBQVksQ0FBQyxFQUFFLEVBQUUsTUFBTSxjQUFjLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRTtnQkFDaEQsUUFBUSxHQUFHLElBQUksQ0FBQztnQkFDaEIsTUFBTTthQUNQO1NBQ0Y7S0FDRjtJQUVELGVBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLDBCQUEwQixDQUFDLENBQUMsQ0FBQyxrQ0FBa0MsQ0FBQyxDQUFDO0lBQ2xGLE9BQU8sUUFBUSxDQUFDO0FBQ2xCLENBQUM7QUFFRCxLQUFLLFVBQVUsaUJBQWlCO0lBQzlCLE1BQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxJQUFJLE9BQU8sQ0FBQyxHQUFHLENBQUMsV0FBVztXQUN0RCxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxTQUFTLElBQUksS0FBSyxDQUFDLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDLE9BQU8sRUFBRSxDQUFDO0lBRS9HLElBQUksTUFBTSxFQUFFLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxRQUFRLENBQUMsQ0FBQyxFQUFFO1FBQ2hFLE9BQU8sQ0FBQyxHQUFHLENBQUMsbUJBQW1CLEdBQUcsR0FBRyxDQUFDO0tBQ3ZDO0FBQ0gsQ0FBQztBQUVELEtBQUssVUFBVSxjQUFjLENBQUMsUUFBZ0I7SUFDNUMsSUFBSTtRQUNGLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLEVBQUU7WUFBRSxPQUFPLFNBQVMsQ0FBQztTQUFFO1FBQ3pELE9BQU8sRUFBRSxDQUFDLFFBQVEsQ0FBQyxRQUFRLEVBQUUsRUFBRSxRQUFRLEVBQUUsT0FBTyxFQUFFLENBQUMsQ0FBQztLQUNyRDtJQUFDLE9BQU8sQ0FBQyxFQUFFO1FBQ1YsZUFBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ1QsT0FBTyxTQUFTLENBQUM7S0FDbEI7QUFDSCxDQUFDO0FBRUQsU0FBUyxZQUFZLENBQUMsRUFBVSxFQUFFLENBQXFCO0lBQ3JELE9BQU8sQ0FBQyxLQUFLLFNBQVMsSUFBSSxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLElBQUksQ0FBQztBQUNoRCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGN4YXBpID0gcmVxdWlyZSgnQGF3cy1jZGsvY3gtYXBpJyk7XG5pbXBvcnQgQVdTID0gcmVxdWlyZSgnYXdzLXNkaycpO1xuaW1wb3J0IGNoaWxkX3Byb2Nlc3MgPSByZXF1aXJlKCdjaGlsZF9wcm9jZXNzJyk7XG5pbXBvcnQgZnMgPSByZXF1aXJlKCdmcy1leHRyYScpO1xuaW1wb3J0IG9zID0gcmVxdWlyZSgnb3MnKTtcbmltcG9ydCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuaW1wb3J0IHV0aWwgPSByZXF1aXJlKCd1dGlsJyk7XG5pbXBvcnQgeyBkZWJ1ZyB9IGZyb20gJy4uLy4uL2xvZ2dpbmcnO1xuaW1wb3J0IHsgUGx1Z2luSG9zdCB9IGZyb20gJy4uLy4uL3BsdWdpbic7XG5pbXBvcnQgeyBDcmVkZW50aWFsUHJvdmlkZXJTb3VyY2UsIE1vZGUgfSBmcm9tICcuLi9hd3MtYXV0aC9jcmVkZW50aWFscyc7XG5pbXBvcnQgeyBBY2NvdW50QWNjZXNzS2V5Q2FjaGUgfSBmcm9tICcuL2FjY291bnQtY2FjaGUnO1xuaW1wb3J0IHsgU2hhcmVkSW5pRmlsZSB9IGZyb20gJy4vc2RrX2luaV9maWxlJztcblxuZXhwb3J0IGludGVyZmFjZSBTREtPcHRpb25zIHtcbiAgLyoqXG4gICAqIFByb2ZpbGUgbmFtZSB0byB1c2VcbiAgICpcbiAgICogQGRlZmF1bHQgTm8gcHJvZmlsZVxuICAgKi9cbiAgcHJvZmlsZT86IHN0cmluZztcblxuICAvKipcbiAgICogUHJveHkgYWRkcmVzcyB0byB1c2VcbiAgICpcbiAgICogQGRlZmF1bHQgTm8gcHJveHlcbiAgICovXG4gIHByb3h5QWRkcmVzcz86IHN0cmluZztcblxuICAvKipcbiAgICogV2hldGhlciB3ZSBzaG91bGQgdHJ5IGluc3RhbmNlIGNyZWRlbnRpYWxzXG4gICAqXG4gICAqIFRydWUvZmFsc2UgdG8gZm9yY2UvZGlzYWJsZS4gRGVmYXVsdCBpcyB0byBndWVzcy5cbiAgICpcbiAgICogQGRlZmF1bHQgQXV0b21hdGljYWxseSBkZXRlcm1pbmUuXG4gICAqL1xuICBlYzJjcmVkcz86IGJvb2xlYW47XG59XG5cbi8qKlxuICogU291cmNlIGZvciBTREsgY2xpZW50IG9iamVjdHNcbiAqXG4gKiBDcmVkZW50aWFscyBhcmUgZmlyc3Qgb2J0YWluZWQgZnJvbSB0aGUgU0RLIGRlZmF1bHRzICh1c2luZyBlbnZpcm9ubWVudCB2YXJpYWJsZXMgYW5kIHRoZVxuICogfi8uYXdzL3tjb25maWcsY3JlZGVudGlhbHN9IGZpbGVzKS5cbiAqXG4gKiBJZiB0aG9zZSBkb24ndCBzdWZmaWNlLCBhIGxpc3Qgb2YgQ3JlZGVudGlhbFByb3ZpZGVyU291cmNlcyBpcyBpbnRlcnJvZ2F0ZWQgZm9yIGFjY2Vzc1xuICogdG8gdGhlIHJlcXVlc3RlZCBhY2NvdW50LlxuICovXG5leHBvcnQgY2xhc3MgU0RLIHtcbiAgcHJpdmF0ZSByZWFkb25seSBkZWZhdWx0QXdzQWNjb3VudDogRGVmYXVsdEFXU0FjY291bnQ7XG4gIHByaXZhdGUgcmVhZG9ubHkgY3JlZGVudGlhbHNDYWNoZTogQ3JlZGVudGlhbHNDYWNoZTtcbiAgcHJpdmF0ZSByZWFkb25seSBwcm9maWxlPzogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBEZWZhdWx0IHJldHJ5IG9wdGlvbnMgZm9yIFNESyBjbGllbnRzXG4gICAqXG4gICAqIEJpZ2dlc3QgYm90dGxlbmVjayBpcyBDbG91ZEZvcm1hdGlvbiwgd2l0aCBhIDF0cHMgY2FsbCByYXRlLiBXZSB3YW50IHRvIGJlXG4gICAqIGEgbGl0dGxlIG1vcmUgdGVuYWNpb3VzIHRoYW4gdGhlIGRlZmF1bHRzLCBhbmQgd2l0aCBhIGxpdHRsZSBtb3JlIGJyZWF0aGluZ1xuICAgKiByb29tIGJldHdlZW4gY2FsbHMgKGRlZmF1bHRzIGFyZSB7cmV0cmllcz0zLCBiYXNlPTEwMH0pLlxuICAgKlxuICAgKiBJJ3ZlIGxlZnQgdGhpcyBydW5uaW5nIGluIGEgdGlnaHQgbG9vcCBmb3IgYW4gaG91ciBhbmQgdGhlIHRocm90dGxlIGVycm9yc1xuICAgKiBoYXZlbid0IGVzY2FwZWQgdGhlIHJldHJ5IG1lY2hhbmlzbS5cbiAgICovXG4gIHByaXZhdGUgcmVhZG9ubHkgcmV0cnlPcHRpb25zID0geyBtYXhSZXRyaWVzOiA2LCByZXRyeURlbGF5T3B0aW9uczogeyBiYXNlOiAzMDAgfX07XG5cbiAgY29uc3RydWN0b3Iob3B0aW9uczogU0RLT3B0aW9ucyA9IHt9KSB7XG4gICAgdGhpcy5wcm9maWxlID0gb3B0aW9ucy5wcm9maWxlO1xuXG4gICAgY29uc3QgZGVmYXVsdENyZWRlbnRpYWxQcm92aWRlciA9IG1ha2VDTElDb21wYXRpYmxlQ3JlZGVudGlhbFByb3ZpZGVyKG9wdGlvbnMucHJvZmlsZSwgb3B0aW9ucy5lYzJjcmVkcyk7XG5cbiAgICAvLyBGaW5kIHRoZSBwYWNrYWdlLmpzb24gZnJvbSB0aGUgbWFpbiB0b29sa2l0XG4gICAgY29uc3QgcGtnID0gKHJlcXVpcmUubWFpbiBhcyBhbnkpLnJlcXVpcmUoJy4uL3BhY2thZ2UuanNvbicpO1xuICAgIEFXUy5jb25maWcudXBkYXRlKHtcbiAgICAgICAgY3VzdG9tVXNlckFnZW50OiBgJHtwa2cubmFtZX0vJHtwa2cudmVyc2lvbn1gXG4gICAgfSk7XG5cbiAgICAvLyBodHRwczovL2F3cy5hbWF6b24uY29tL2Jsb2dzL2RldmVsb3Blci91c2luZy10aGUtYXdzLXNkay1mb3ItamF2YXNjcmlwdC1mcm9tLWJlaGluZC1hLXByb3h5L1xuICAgIGlmIChvcHRpb25zLnByb3h5QWRkcmVzcyA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICBvcHRpb25zLnByb3h5QWRkcmVzcyA9IGh0dHBzUHJveHlGcm9tRW52aXJvbm1lbnQoKTtcbiAgICB9XG4gICAgaWYgKG9wdGlvbnMucHJveHlBZGRyZXNzKSB7IC8vIElnbm9yZSBlbXB0eSBzdHJpbmcgb24gcHVycG9zZVxuICAgICAgZGVidWcoJ1VzaW5nIHByb3h5IHNlcnZlcjogJXMnLCBvcHRpb25zLnByb3h5QWRkcmVzcyk7XG4gICAgICBBV1MuY29uZmlnLnVwZGF0ZSh7XG4gICAgICAgIGh0dHBPcHRpb25zOiB7IGFnZW50OiByZXF1aXJlKCdwcm94eS1hZ2VudCcpKG9wdGlvbnMucHJveHlBZGRyZXNzKSB9XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICB0aGlzLmRlZmF1bHRBd3NBY2NvdW50ID0gbmV3IERlZmF1bHRBV1NBY2NvdW50KGRlZmF1bHRDcmVkZW50aWFsUHJvdmlkZXIsIGdldENMSUNvbXBhdGlibGVEZWZhdWx0UmVnaW9uR2V0dGVyKHRoaXMucHJvZmlsZSkpO1xuICAgIHRoaXMuY3JlZGVudGlhbHNDYWNoZSA9IG5ldyBDcmVkZW50aWFsc0NhY2hlKHRoaXMuZGVmYXVsdEF3c0FjY291bnQsIGRlZmF1bHRDcmVkZW50aWFsUHJvdmlkZXIpO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGNsb3VkRm9ybWF0aW9uKGFjY291bnQ6IHN0cmluZyB8IHVuZGVmaW5lZCwgcmVnaW9uOiBzdHJpbmcgfCB1bmRlZmluZWQsIG1vZGU6IE1vZGUpOiBQcm9taXNlPEFXUy5DbG91ZEZvcm1hdGlvbj4ge1xuICAgIGNvbnN0IGVudmlyb25tZW50ID0gYXdhaXQgdGhpcy5yZXNvbHZlRW52aXJvbm1lbnQoYWNjb3VudCwgcmVnaW9uKTtcbiAgICByZXR1cm4gbmV3IEFXUy5DbG91ZEZvcm1hdGlvbih7XG4gICAgICAuLi50aGlzLnJldHJ5T3B0aW9ucyxcbiAgICAgIHJlZ2lvbjogZW52aXJvbm1lbnQucmVnaW9uLFxuICAgICAgY3JlZGVudGlhbHM6IGF3YWl0IHRoaXMuY3JlZGVudGlhbHNDYWNoZS5nZXQoZW52aXJvbm1lbnQuYWNjb3VudCwgbW9kZSlcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBlYzIoYWNjb3VudDogc3RyaW5nIHwgdW5kZWZpbmVkLCByZWdpb246IHN0cmluZyB8IHVuZGVmaW5lZCwgbW9kZTogTW9kZSk6IFByb21pc2U8QVdTLkVDMj4ge1xuICAgIGNvbnN0IGVudmlyb25tZW50ID0gYXdhaXQgdGhpcy5yZXNvbHZlRW52aXJvbm1lbnQoYWNjb3VudCwgcmVnaW9uKTtcbiAgICByZXR1cm4gbmV3IEFXUy5FQzIoe1xuICAgICAgLi4udGhpcy5yZXRyeU9wdGlvbnMsXG4gICAgICByZWdpb246IGVudmlyb25tZW50LnJlZ2lvbixcbiAgICAgIGNyZWRlbnRpYWxzOiBhd2FpdCB0aGlzLmNyZWRlbnRpYWxzQ2FjaGUuZ2V0KGVudmlyb25tZW50LmFjY291bnQsIG1vZGUpXG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgc3NtKGFjY291bnQ6IHN0cmluZyB8IHVuZGVmaW5lZCwgcmVnaW9uOiBzdHJpbmcgfCB1bmRlZmluZWQsIG1vZGU6IE1vZGUpOiBQcm9taXNlPEFXUy5TU00+IHtcbiAgICBjb25zdCBlbnZpcm9ubWVudCA9IGF3YWl0IHRoaXMucmVzb2x2ZUVudmlyb25tZW50KGFjY291bnQsIHJlZ2lvbik7XG4gICAgcmV0dXJuIG5ldyBBV1MuU1NNKHtcbiAgICAgIC4uLnRoaXMucmV0cnlPcHRpb25zLFxuICAgICAgcmVnaW9uOiBlbnZpcm9ubWVudC5yZWdpb24sXG4gICAgICBjcmVkZW50aWFsczogYXdhaXQgdGhpcy5jcmVkZW50aWFsc0NhY2hlLmdldChlbnZpcm9ubWVudC5hY2NvdW50LCBtb2RlKVxuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIHMzKGFjY291bnQ6IHN0cmluZyB8IHVuZGVmaW5lZCwgcmVnaW9uOiBzdHJpbmcgfCB1bmRlZmluZWQsIG1vZGU6IE1vZGUpOiBQcm9taXNlPEFXUy5TMz4ge1xuICAgIGNvbnN0IGVudmlyb25tZW50ID0gYXdhaXQgdGhpcy5yZXNvbHZlRW52aXJvbm1lbnQoYWNjb3VudCwgcmVnaW9uKTtcbiAgICByZXR1cm4gbmV3IEFXUy5TMyh7XG4gICAgICAuLi50aGlzLnJldHJ5T3B0aW9ucyxcbiAgICAgIHJlZ2lvbjogZW52aXJvbm1lbnQucmVnaW9uLFxuICAgICAgY3JlZGVudGlhbHM6IGF3YWl0IHRoaXMuY3JlZGVudGlhbHNDYWNoZS5nZXQoZW52aXJvbm1lbnQuYWNjb3VudCwgbW9kZSlcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyByb3V0ZTUzKGFjY291bnQ6IHN0cmluZyB8IHVuZGVmaW5lZCwgcmVnaW9uOiBzdHJpbmcgfCB1bmRlZmluZWQsIG1vZGU6IE1vZGUpOiBQcm9taXNlPEFXUy5Sb3V0ZTUzPiB7XG4gICAgY29uc3QgZW52aXJvbm1lbnQgPSBhd2FpdCB0aGlzLnJlc29sdmVFbnZpcm9ubWVudChhY2NvdW50LCByZWdpb24pO1xuICAgIHJldHVybiBuZXcgQVdTLlJvdXRlNTMoe1xuICAgICAgLi4udGhpcy5yZXRyeU9wdGlvbnMsXG4gICAgICByZWdpb246IGVudmlyb25tZW50LnJlZ2lvbixcbiAgICAgIGNyZWRlbnRpYWxzOiBhd2FpdCB0aGlzLmNyZWRlbnRpYWxzQ2FjaGUuZ2V0KGVudmlyb25tZW50LmFjY291bnQsIG1vZGUpLFxuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGVjcihhY2NvdW50OiBzdHJpbmcgfCB1bmRlZmluZWQsIHJlZ2lvbjogc3RyaW5nIHwgdW5kZWZpbmVkLCBtb2RlOiBNb2RlKTogUHJvbWlzZTxBV1MuRUNSPiB7XG4gICAgY29uc3QgZW52aXJvbm1lbnQgPSBhd2FpdCB0aGlzLnJlc29sdmVFbnZpcm9ubWVudChhY2NvdW50LCByZWdpb24pO1xuICAgIHJldHVybiBuZXcgQVdTLkVDUih7XG4gICAgICAuLi50aGlzLnJldHJ5T3B0aW9ucyxcbiAgICAgIHJlZ2lvbjogZW52aXJvbm1lbnQucmVnaW9uLFxuICAgICAgY3JlZGVudGlhbHM6IGF3YWl0IHRoaXMuY3JlZGVudGlhbHNDYWNoZS5nZXQoZW52aXJvbm1lbnQuYWNjb3VudCwgbW9kZSlcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBkZWZhdWx0UmVnaW9uKCk6IFByb21pc2U8c3RyaW5nIHwgdW5kZWZpbmVkPiB7XG4gICAgcmV0dXJuIGF3YWl0IGdldENMSUNvbXBhdGlibGVEZWZhdWx0UmVnaW9uR2V0dGVyKHRoaXMucHJvZmlsZSkoKTtcbiAgfVxuXG4gIHB1YmxpYyBkZWZhdWx0QWNjb3VudCgpOiBQcm9taXNlPHN0cmluZyB8IHVuZGVmaW5lZD4ge1xuICAgIHJldHVybiB0aGlzLmRlZmF1bHRBd3NBY2NvdW50LmdldCgpO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyByZXNvbHZlRW52aXJvbm1lbnQoYWNjb3VudDogc3RyaW5nIHwgdW5kZWZpbmVkLCByZWdpb246IHN0cmluZyB8IHVuZGVmaW5lZCwgKSB7XG4gICAgaWYgKHJlZ2lvbiA9PT0gY3hhcGkuVU5LTk9XTl9SRUdJT04pIHtcbiAgICAgIHJlZ2lvbiA9IGF3YWl0IHRoaXMuZGVmYXVsdFJlZ2lvbigpO1xuICAgIH1cblxuICAgIGlmIChhY2NvdW50ID09PSBjeGFwaS5VTktOT1dOX0FDQ09VTlQpIHtcbiAgICAgIGFjY291bnQgPSBhd2FpdCB0aGlzLmRlZmF1bHRBY2NvdW50KCk7XG4gICAgfVxuXG4gICAgaWYgKCFyZWdpb24pIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQVdTIHJlZ2lvbiBtdXN0IGJlIGNvbmZpZ3VyZWQgZWl0aGVyIHdoZW4geW91IGNvbmZpZ3VyZSB5b3VyIENESyBzdGFjayBvciB0aHJvdWdoIHRoZSBlbnZpcm9ubWVudGApO1xuICAgIH1cblxuICAgIGlmICghYWNjb3VudCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmFibGUgdG8gcmVzb2x2ZSBBV1MgYWNjb3VudCB0byB1c2UuIEl0IG11c3QgYmUgZWl0aGVyIGNvbmZpZ3VyZWQgd2hlbiB5b3UgZGVmaW5lIHlvdXIgQ0RLIG9yIHRocm91Z2ggdGhlIGVudmlyb25tZW50YCk7XG4gICAgfVxuXG4gICAgY29uc3QgZW52aXJvbm1lbnQ6IGN4YXBpLkVudmlyb25tZW50ID0ge1xuICAgICAgcmVnaW9uLCBhY2NvdW50LCBuYW1lOiBjeGFwaS5FbnZpcm9ubWVudFV0aWxzLmZvcm1hdChhY2NvdW50LCByZWdpb24pXG4gICAgfTtcblxuICAgIHJldHVybiBlbnZpcm9ubWVudDtcbiAgfVxuXG59XG5cbi8qKlxuICogQ2FjaGUgZm9yIGNyZWRlbnRpYWwgcHJvdmlkZXJzLlxuICpcbiAqIEdpdmVuIGFuIGFjY291bnQgYW5kIGFuIG9wZXJhdGluZyBtb2RlIChyZWFkIG9yIHdyaXRlKSB3aWxsIHJldHVybiBhblxuICogYXBwcm9wcmlhdGUgY3JlZGVudGlhbCBwcm92aWRlciBmb3IgY3JlZGVudGlhbHMgZm9yIHRoZSBnaXZlbiBhY2NvdW50LiBUaGVcbiAqIGNyZWRlbnRpYWwgcHJvdmlkZXIgd2lsbCBiZSBjYWNoZWQgc28gdGhhdCBtdWx0aXBsZSBBV1MgY2xpZW50cyBmb3IgdGhlIHNhbWVcbiAqIGVudmlyb25tZW50IHdpbGwgbm90IG1ha2UgbXVsdGlwbGUgbmV0d29yayBjYWxscyB0byBvYnRhaW4gY3JlZGVudGlhbHMuXG4gKlxuICogV2lsbCB1c2UgZGVmYXVsdCBjcmVkZW50aWFscyBpZiB0aGV5IGFyZSBmb3IgdGhlIHJpZ2h0IGFjY291bnQ7IG90aGVyd2lzZSxcbiAqIGFsbCBsb2FkZWQgY3JlZGVudGlhbCBwcm92aWRlciBwbHVnaW5zIHdpbGwgYmUgdHJpZWQgdG8gb2J0YWluIGNyZWRlbnRpYWxzXG4gKiBmb3IgdGhlIGdpdmVuIGFjY291bnQuXG4gKi9cbmNsYXNzIENyZWRlbnRpYWxzQ2FjaGUge1xuICBwcml2YXRlIHJlYWRvbmx5IGNhY2hlOiB7W2tleTogc3RyaW5nXTogQVdTLkNyZWRlbnRpYWxzfSA9IHt9O1xuXG4gIHB1YmxpYyBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IGRlZmF1bHRBd3NBY2NvdW50OiBEZWZhdWx0QVdTQWNjb3VudCxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGRlZmF1bHRDcmVkZW50aWFsUHJvdmlkZXI6IFByb21pc2U8QVdTLkNyZWRlbnRpYWxQcm92aWRlckNoYWluPikge1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGdldChhd3NBY2NvdW50SWQ6IHN0cmluZyB8IHVuZGVmaW5lZCwgbW9kZTogTW9kZSk6IFByb21pc2U8QVdTLkNyZWRlbnRpYWxzPiB7XG4gICAgY29uc3Qga2V5ID0gYCR7YXdzQWNjb3VudElkfS0ke21vZGV9YDtcbiAgICBpZiAoIShrZXkgaW4gdGhpcy5jYWNoZSkpIHtcbiAgICAgIHRoaXMuY2FjaGVba2V5XSA9IGF3YWl0IHRoaXMuZ2V0Q3JlZGVudGlhbHMoYXdzQWNjb3VudElkLCBtb2RlKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuY2FjaGVba2V5XTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgZ2V0Q3JlZGVudGlhbHMoYXdzQWNjb3VudElkOiBzdHJpbmcgfCB1bmRlZmluZWQsIG1vZGU6IE1vZGUpOiBQcm9taXNlPEFXUy5DcmVkZW50aWFscz4ge1xuICAgIC8vIElmIHJlcXVlc3RlZCBhY2NvdW50IGlzIHVuZGVmaW5lZCBvciBlcXVhbCB0byBkZWZhdWx0IGFjY291bnQsIHVzZSBkZWZhdWx0IGNyZWRlbnRpYWxzIHByb3ZpZGVyLlxuICAgIC8vIChOb3RlIHRoYXQgd2UgaWdub3JlIHRoZSBtb2RlIGluIHRoaXMgY2FzZSwgaWYgeW91IHByZWxvYWRlZCBjcmVkZW50aWFscyB0aGV5IGJldHRlciBiZSBjb3JyZWN0ISlcbiAgICBjb25zdCBkZWZhdWx0QWNjb3VudCA9IGF3YWl0IHRoaXMuZGVmYXVsdEF3c0FjY291bnQuZ2V0KCk7XG4gICAgaWYgKCFhd3NBY2NvdW50SWQgfHwgYXdzQWNjb3VudElkID09PSBkZWZhdWx0QWNjb3VudCB8fCBhd3NBY2NvdW50SWQgPT09IGN4YXBpLlVOS05PV05fQUNDT1VOVCkge1xuICAgICAgZGVidWcoYFVzaW5nIGRlZmF1bHQgQVdTIFNESyBjcmVkZW50aWFscyBmb3IgYWNjb3VudCAke2F3c0FjY291bnRJZH1gKTtcblxuICAgICAgLy8gQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW4gZXh0ZW5kcyBDcmVkZW50aWFscywgYnV0IHRoYXQgaXMgYSBsaWUuXG4gICAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vYXdzL2F3cy1zZGstanMvaXNzdWVzLzIyMzVcbiAgICAgIC8vIENhbGwgcmVzb2x2ZSgpIGluc3RlYWQuXG4gICAgICByZXR1cm4gKGF3YWl0IHRoaXMuZGVmYXVsdENyZWRlbnRpYWxQcm92aWRlcikucmVzb2x2ZVByb21pc2UoKTtcbiAgICB9XG5cbiAgICBjb25zdCB0cmllZFNvdXJjZXM6IENyZWRlbnRpYWxQcm92aWRlclNvdXJjZVtdID0gW107XG4gICAgLy8gT3RoZXJ3aXNlLCBpbnNwZWN0IHRoZSB2YXJpb3VzIGNyZWRlbnRpYWwgc291cmNlcyB3ZSBoYXZlXG4gICAgZm9yIChjb25zdCBzb3VyY2Ugb2YgUGx1Z2luSG9zdC5pbnN0YW5jZS5jcmVkZW50aWFsUHJvdmlkZXJTb3VyY2VzKSB7XG4gICAgICBpZiAoIShhd2FpdCBzb3VyY2UuaXNBdmFpbGFibGUoKSkpIHtcbiAgICAgICAgZGVidWcoJ0NyZWRlbnRpYWxzIHNvdXJjZSAlcyBpcyBub3QgYXZhaWxhYmxlLCBpZ25vcmluZyBpdC4nLCBzb3VyY2UubmFtZSk7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgdHJpZWRTb3VyY2VzLnB1c2goc291cmNlKTtcbiAgICAgIGlmICghKGF3YWl0IHNvdXJjZS5jYW5Qcm92aWRlQ3JlZGVudGlhbHMoYXdzQWNjb3VudElkKSkpIHsgY29udGludWU7IH1cbiAgICAgIGRlYnVnKGBVc2luZyAke3NvdXJjZS5uYW1lfSBjcmVkZW50aWFscyBmb3IgYWNjb3VudCAke2F3c0FjY291bnRJZH1gKTtcbiAgICAgIGNvbnN0IHByb3ZpZGVyT3JDcmVkcyA9IGF3YWl0IHNvdXJjZS5nZXRQcm92aWRlcihhd3NBY2NvdW50SWQsIG1vZGUpO1xuXG4gICAgICAvLyBCYWNrd2FyZHMgY29tcGF0aWJpbGl0eTogaWYgdGhlIHBsdWdpbiByZXR1cm5zIGEgUHJvdmlkZXJDaGFpbiwgcmVzb2x2ZSB0aGF0IGNoYWluLlxuICAgICAgLy8gT3RoZXJ3aXNlIGl0IG11c3QgaGF2ZSByZXR1cm5lZCBjcmVkZW50aWFscy5cbiAgICAgIGlmICgocHJvdmlkZXJPckNyZWRzIGFzIGFueSkucmVzb2x2ZVByb21pc2UpIHtcbiAgICAgICAgcmV0dXJuIGF3YWl0IChwcm92aWRlck9yQ3JlZHMgYXMgYW55KS5yZXNvbHZlUHJvbWlzZSgpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHByb3ZpZGVyT3JDcmVkcztcbiAgICB9XG4gICAgY29uc3Qgc291cmNlTmFtZXMgPSBbJ2RlZmF1bHQgY3JlZGVudGlhbHMnXS5jb25jYXQodHJpZWRTb3VyY2VzLm1hcChzID0+IHMubmFtZSkpLmpvaW4oJywgJyk7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBOZWVkIHRvIHBlcmZvcm0gQVdTIGNhbGxzIGZvciBhY2NvdW50ICR7YXdzQWNjb3VudElkfSwgYnV0IG5vIGNyZWRlbnRpYWxzIGZvdW5kLiBUcmllZDogJHtzb3VyY2VOYW1lc30uYCk7XG4gIH1cbn1cblxuLyoqXG4gKiBDbGFzcyB0byByZXRyaWV2ZSB0aGUgYWNjb3VudCBmb3IgZGVmYXVsdCBjcmVkZW50aWFscyBhbmQgY2FjaGUgaXQuXG4gKlxuICogVXNlcyB0aGUgZGVmYXVsdCBjcmVkZW50aWFscyBwcm92aWRlciB0byBvYnRhaW4gY3JlZGVudGlhbHMgKGlmIGF2YWlsYWJsZSksXG4gKiBhbmQgdXNlcyB0aG9zZSBjcmVkZW50aWFscyB0byBjYWxsIFNUUyB0byByZXF1ZXN0IHRoZSBjdXJyZW50IGFjY291bnQgSUQuXG4gKlxuICogVGhlIGNyZWRlbnRpYWxzID0+IGFjY291bnRJZCBsb29rdXAgaXMgY2FjaGVkIG9uIGRpc2ssIHNpbmNlIGl0J3NcbiAqIGd1YXJhbnRlZWQgdGhhdCBpZ3ZlbiBhY2Nlc3Mga2V5IHdpbGwgYWx3YXlzIHJlbWFpbiBmb3IgdGhlIHNhbWUgYWNjb3VudC5cbiAqL1xuY2xhc3MgRGVmYXVsdEFXU0FjY291bnQge1xuICBwcml2YXRlIGRlZmF1bHRBY2NvdW50RmV0Y2hlZCA9IGZhbHNlO1xuICBwcml2YXRlIGRlZmF1bHRBY2NvdW50SWQ/OiBzdHJpbmcgPSB1bmRlZmluZWQ7XG4gIHByaXZhdGUgcmVhZG9ubHkgYWNjb3VudENhY2hlID0gbmV3IEFjY291bnRBY2Nlc3NLZXlDYWNoZSgpO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgICAgcHJpdmF0ZSByZWFkb25seSBkZWZhdWx0Q3JlZGVudGlhbHNQcm92aWRlcjogUHJvbWlzZTxBV1MuQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW4+LFxuICAgICAgcHJpdmF0ZSByZWFkb25seSByZWdpb246ICgpID0+IFByb21pc2U8c3RyaW5nIHwgdW5kZWZpbmVkPikge1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybiB0aGUgZGVmYXVsdCBhY2NvdW50XG4gICAqL1xuICBwdWJsaWMgYXN5bmMgZ2V0KCk6IFByb21pc2U8c3RyaW5nIHwgdW5kZWZpbmVkPiB7XG4gICAgaWYgKCF0aGlzLmRlZmF1bHRBY2NvdW50RmV0Y2hlZCkge1xuICAgICAgdGhpcy5kZWZhdWx0QWNjb3VudElkID0gYXdhaXQgdGhpcy5sb29rdXBEZWZhdWx0QWNjb3VudCgpO1xuICAgICAgdGhpcy5kZWZhdWx0QWNjb3VudEZldGNoZWQgPSB0cnVlO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5kZWZhdWx0QWNjb3VudElkO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBsb29rdXBEZWZhdWx0QWNjb3VudCgpOiBQcm9taXNlPHN0cmluZyB8IHVuZGVmaW5lZD4ge1xuICAgIHRyeSB7XG4gICAgICAvLyBUaGVyZSBqdXN0IGlzICpOTyogd2F5IHRvIGRvIEFzc3VtZVJvbGUgY3JlZGVudGlhbHMgYXMgbG9uZyBhcyBBV1NfU0RLX0xPQURfQ09ORklHIGlzIG5vdCBzZXQuIFRoZSBTREtcbiAgICAgIC8vIGNyYXNoIGlmIHRoZSBmaWxlIGRvZXMgbm90IGV4aXN0IHRob3VnaC4gU28gc2V0IHRoZSBlbnZpcm9ubWVudCB2YXJpYWJsZSBpZiB3ZSBjYW4gZmluZCB0aGF0IGZpbGUuXG4gICAgICBhd2FpdCBzZXRDb25maWdWYXJpYWJsZSgpO1xuXG4gICAgICBkZWJ1ZygnUmVzb2x2aW5nIGRlZmF1bHQgY3JlZGVudGlhbHMnKTtcbiAgICAgIGNvbnN0IGNyZWRlbnRpYWxQcm92aWRlciA9IGF3YWl0IHRoaXMuZGVmYXVsdENyZWRlbnRpYWxzUHJvdmlkZXI7XG4gICAgICBjb25zdCBjcmVkcyA9IGF3YWl0IGNyZWRlbnRpYWxQcm92aWRlci5yZXNvbHZlUHJvbWlzZSgpO1xuXG4gICAgICBjb25zdCBhY2Nlc3NLZXlJZCA9IGNyZWRzLmFjY2Vzc0tleUlkO1xuICAgICAgaWYgKCFhY2Nlc3NLZXlJZCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1VuYWJsZSB0byByZXNvbHZlIEFXUyBjcmVkZW50aWFscyAoc2V0dXAgd2l0aCBcImF3cyBjb25maWd1cmVcIiknKTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgYWNjb3VudElkID0gYXdhaXQgdGhpcy5hY2NvdW50Q2FjaGUuZmV0Y2goY3JlZHMuYWNjZXNzS2V5SWQsIGFzeW5jICgpID0+IHtcbiAgICAgICAgLy8gaWYgd2UgZG9uJ3QgaGF2ZSBvbmUsIHJlc29sdmUgZnJvbSBTVFMgYW5kIHN0b3JlIGluIGNhY2hlLlxuICAgICAgICBkZWJ1ZygnTG9va2luZyB1cCBkZWZhdWx0IGFjY291bnQgSUQgZnJvbSBTVFMnKTtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgbmV3IEFXUy5TVFMoeyBjcmVkZW50aWFsczogY3JlZHMsIHJlZ2lvbjogYXdhaXQgdGhpcy5yZWdpb24oKSB9KS5nZXRDYWxsZXJJZGVudGl0eSgpLnByb21pc2UoKTtcbiAgICAgICAgY29uc3QgYWlkID0gcmVzdWx0LkFjY291bnQ7XG4gICAgICAgIGlmICghYWlkKSB7XG4gICAgICAgICAgZGVidWcoJ1NUUyBkaWRuXFwndCByZXR1cm4gYW4gYWNjb3VudCBJRCcpO1xuICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICAgIH1cbiAgICAgICAgZGVidWcoJ0RlZmF1bHQgYWNjb3VudCBJRDonLCBhaWQpO1xuICAgICAgICByZXR1cm4gYWlkO1xuICAgICAgfSk7XG5cbiAgICAgIHJldHVybiBhY2NvdW50SWQ7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgZGVidWcoJ1VuYWJsZSB0byBkZXRlcm1pbmUgdGhlIGRlZmF1bHQgQVdTIGFjY291bnQgKGRpZCB5b3UgY29uZmlndXJlIFwiYXdzIGNvbmZpZ3VyZVwiPyk6JywgZSk7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cbiAgfVxufVxuXG4vKipcbiAqIEJ1aWxkIGFuIEFXUyBDTEktY29tcGF0aWJsZSBjcmVkZW50aWFsIGNoYWluIHByb3ZpZGVyXG4gKlxuICogVGhpcyBpcyBzaW1pbGFyIHRvIHRoZSBkZWZhdWx0IGNyZWRlbnRpYWwgcHJvdmlkZXIgY2hhaW4gY3JlYXRlZCBieSB0aGUgU0RLXG4gKiBleGNlcHQgaXQgYWxzbyBhY2NlcHRzIHRoZSBwcm9maWxlIGFyZ3VtZW50IGluIHRoZSBjb25zdHJ1Y3RvciAobm90IGp1c3QgZnJvbVxuICogdGhlIGVudmlyb25tZW50KS5cbiAqXG4gKiBUbyBtaW1pYyB0aGUgQVdTIENMSSBiZWhhdmlvcjpcbiAqXG4gKiAtIHdlIGRlZmF1bHQgdG8gfi8uYXdzL2NyZWRlbnRpYWxzIGlmIGVudmlyb25tZW50IHZhcmlhYmxlIGZvciBjcmVkZW50aWFsc1xuICogZmlsZSBsb2NhdGlvbiBpcyBub3QgZ2l2ZW4gKFNESyBleHBlY3RzIGV4cGxpY2l0IGVudmlyb25tZW50IHZhcmlhYmxlIHdpdGggbmFtZSkuXG4gKiAtIEFXU19ERUZBVUxUX1BST0ZJTEUgaXMgYWxzbyBpbnNwZWN0ZWQgZm9yIHByb2ZpbGUgbmFtZSAobm90IGp1c3QgQVdTX1BST0ZJTEUpLlxuICovXG5hc3luYyBmdW5jdGlvbiBtYWtlQ0xJQ29tcGF0aWJsZUNyZWRlbnRpYWxQcm92aWRlcihwcm9maWxlOiBzdHJpbmcgfCB1bmRlZmluZWQsIGVjMmNyZWRzOiBib29sZWFuIHwgdW5kZWZpbmVkKSB7XG4gIHByb2ZpbGUgPSBwcm9maWxlIHx8IHByb2Nlc3MuZW52LkFXU19QUk9GSUxFIHx8IHByb2Nlc3MuZW52LkFXU19ERUZBVUxUX1BST0ZJTEUgfHwgJ2RlZmF1bHQnO1xuXG4gIC8vIE5lZWQgdG8gY29uc3RydWN0IGZpbGVuYW1lIG91cnNlbHZlcywgd2l0aG91dCBhcHByb3ByaWF0ZSBlbnZpcm9ubWVudCB2YXJpYWJsZXNcbiAgLy8gbm8gZGVmYXVsdHMgdXNlZCBieSBKUyBTREsuXG4gIGNvbnN0IGZpbGVuYW1lID0gcHJvY2Vzcy5lbnYuQVdTX1NIQVJFRF9DUkVERU5USUFMU19GSUxFIHx8IHBhdGguam9pbihvcy5ob21lZGlyKCksICcuYXdzJywgJ2NyZWRlbnRpYWxzJyk7XG5cbiAgY29uc3Qgc291cmNlcyA9IFtcbiAgICAoKSA9PiBuZXcgQVdTLkVudmlyb25tZW50Q3JlZGVudGlhbHMoJ0FXUycpLFxuICAgICgpID0+IG5ldyBBV1MuRW52aXJvbm1lbnRDcmVkZW50aWFscygnQU1BWk9OJyksXG4gIF07XG4gIGlmIChmcy5wYXRoRXhpc3RzKGZpbGVuYW1lKSkge1xuICAgIHNvdXJjZXMucHVzaCgoKSA9PiBuZXcgQVdTLlNoYXJlZEluaUZpbGVDcmVkZW50aWFscyh7IHByb2ZpbGUsIGZpbGVuYW1lIH0pKTtcbiAgfVxuXG4gIGlmIChoYXNFY3NDcmVkZW50aWFscygpKSB7XG4gICAgc291cmNlcy5wdXNoKCgpID0+IG5ldyBBV1MuRUNTQ3JlZGVudGlhbHMoKSk7XG4gIH0gZWxzZSB7XG4gICAgLy8gZWxzZSBpZjogZG9uJ3QgZ2V0IEVDMiBjcmVkcyBpZiB3ZSBzaG91bGQgaGF2ZSBnb3R0ZW4gRUNTIGNyZWRzLS1FQ1MgaW5zdGFuY2VzIGFsc29cbiAgICAvLyBydW4gb24gRUMyIGJveGVzIGJ1dCB0aGUgY3JlZHMgcmVwcmVzZW50IHNvbWV0aGluZyBkaWZmZXJlbnQuIFNhbWUgYmVoYXZpb3IgYXNcbiAgICAvLyB1cHN0cmVhbSBjb2RlLlxuXG4gICAgaWYgKGVjMmNyZWRzID09PSB1bmRlZmluZWQpIHsgZWMyY3JlZHMgPSBhd2FpdCBoYXNFYzJDcmVkZW50aWFscygpOyB9XG5cbiAgICBpZiAoZWMyY3JlZHMpIHtcbiAgICAgIHNvdXJjZXMucHVzaCgoKSA9PiBuZXcgQVdTLkVDMk1ldGFkYXRhQ3JlZGVudGlhbHMoKSk7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIG5ldyBBV1MuQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW4oc291cmNlcyk7XG59XG5cbi8qKlxuICogUmV0dXJuIHRoZSBkZWZhdWx0IHJlZ2lvbiBpbiBhIENMSS1jb21wYXRpYmxlIHdheVxuICpcbiAqIE1vc3RseSBjb3BpZWQgZnJvbSBub2RlX2xvYWRlci5qcywgYnV0IHdpdGggdGhlIGZvbGxvd2luZyBkaWZmZXJlbmNlczpcbiAqXG4gKiAtIFRha2VzIGEgcnVudGltZSBwcm9maWxlIG5hbWUgdG8gbG9hZCB0aGUgcmVnaW9uIGZyb20sIG5vdCBqdXN0IGJhc2VkIG9uIGVudmlyb25tZW50XG4gKiAgIHZhcmlhYmxlcyBhdCBwcm9jZXNzIHN0YXJ0LlxuICogLSBXZSBoYXZlIG5lZWRlZCB0byBjcmVhdGUgYSBsb2NhbCBjb3B5IG9mIHRoZSBTaGFyZWRJbmlGaWxlIGNsYXNzIGJlY2F1c2UgdGhlXG4gKiAgIGltcGxlbWVudGF0aW9uIGluICdhd3Mtc2RrJyBpcyBwcml2YXRlIChhbmQgdGhlIGRlZmF1bHQgdXNlIG9mIGl0IGluIHRoZVxuICogICBTREsgZG9lcyBub3QgYWxsb3cgdXMgdG8gc3BlY2lmeSBhIHByb2ZpbGUgYXQgcnVudGltZSkuXG4gKiAtIEFXU19ERUZBVUxUX1BST0ZJTEUgYW5kIEFXU19ERUZBVUxUX1JFR0lPTiBhcmUgYWxzbyB1c2VkIGFzIGVudmlyb25tZW50XG4gKiAgIHZhcmlhYmxlcyB0byBiZSB1c2VkIHRvIGRldGVybWluZSB0aGUgcmVnaW9uLlxuICpcbiAqIFJldHVybnMgYSBmdW5jdGlvbiB0aGF0IGNhbiBiZSBpbnZva2VkIHRvIHJldHJpZXZlIHRoZSBhY3R1YWwgcmVnaW9uIHZhbHVlXG4gKiAodXNlZCB0byBiZSBqdXN0IGEgcHJvbWlzZSwgYnV0IHRoYXQgd291bGQgbGVhZCB0byBmaXJpbmcgb2ZmIGEgZmFpbGluZ1xuICogb3BlcmF0aW9uIGFuZCBpZiBpdCB3YXMgbmV2ZXIgYXdhaXRlZCBOb2RlSlMgd291bGQgY29tcGxhaW4pLlxuICovXG5mdW5jdGlvbiBnZXRDTElDb21wYXRpYmxlRGVmYXVsdFJlZ2lvbkdldHRlcihwcm9maWxlOiBzdHJpbmcgfCB1bmRlZmluZWQpOiAoKSA9PiBQcm9taXNlPHN0cmluZyB8IHVuZGVmaW5lZD4ge1xuICBsZXQgcmV0cmlldmVkID0gZmFsc2U7XG4gIGxldCByZWdpb246IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgcmV0dXJuIGFzeW5jICgpID0+IHtcbiAgICBpZiAoIXJldHJpZXZlZCkge1xuICAgICAgcHJvZmlsZSA9IHByb2ZpbGUgfHwgcHJvY2Vzcy5lbnYuQVdTX1BST0ZJTEUgfHwgcHJvY2Vzcy5lbnYuQVdTX0RFRkFVTFRfUFJPRklMRSB8fCAnZGVmYXVsdCc7XG5cbiAgICAgIC8vIERlZmF1bHRzIGluc2lkZSBjb25zdHJ1Y3RvclxuICAgICAgY29uc3QgdG9DaGVjayA9IFtcbiAgICAgICAge2ZpbGVuYW1lOiBwcm9jZXNzLmVudi5BV1NfU0hBUkVEX0NSRURFTlRJQUxTX0ZJTEUgfSxcbiAgICAgICAge2lzQ29uZmlnOiB0cnVlLCBmaWxlbmFtZTogcHJvY2Vzcy5lbnYuQVdTX0NPTkZJR19GSUxFfSxcbiAgICAgIF07XG5cbiAgICAgIHJlZ2lvbiA9IHByb2Nlc3MuZW52LkFXU19SRUdJT04gfHwgcHJvY2Vzcy5lbnYuQU1BWk9OX1JFR0lPTiB8fFxuICAgICAgICBwcm9jZXNzLmVudi5BV1NfREVGQVVMVF9SRUdJT04gfHwgcHJvY2Vzcy5lbnYuQU1BWk9OX0RFRkFVTFRfUkVHSU9OO1xuXG4gICAgICB3aGlsZSAoIXJlZ2lvbiAmJiB0b0NoZWNrLmxlbmd0aCA+IDApIHtcbiAgICAgICAgY29uc3QgY29uZmlnRmlsZSA9IG5ldyBTaGFyZWRJbmlGaWxlKHRvQ2hlY2suc2hpZnQoKSk7XG4gICAgICAgIGNvbnN0IHNlY3Rpb24gPSBhd2FpdCBjb25maWdGaWxlLmdldFByb2ZpbGUocHJvZmlsZSk7XG4gICAgICAgIHJlZ2lvbiA9IHNlY3Rpb24gJiYgc2VjdGlvbi5yZWdpb247XG4gICAgICB9XG5cbiAgICAgIGlmICghcmVnaW9uKSB7XG4gICAgICAgIGNvbnN0IHVzZWRQcm9maWxlID0gIXByb2ZpbGUgPyAnJyA6IGAgKHByb2ZpbGU6IFwiJHtwcm9maWxlfVwiKWA7XG4gICAgICAgIGRlYnVnKGBVbmFibGUgdG8gZGV0ZXJtaW5lIEFXUyByZWdpb24gZnJvbSBlbnZpcm9ubWVudCBvciBBV1MgY29uZmlndXJhdGlvbiR7dXNlZFByb2ZpbGV9YCk7XG4gICAgICB9XG5cbiAgICAgIHJldHJpZXZlZCA9IHRydWU7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlZ2lvbjtcbiAgfTtcbn1cblxuLyoqXG4gKiBGaW5kIGFuZCByZXR1cm4gdGhlIGNvbmZpZ3VyZWQgSFRUUFMgcHJveHkgYWRkcmVzc1xuICovXG5mdW5jdGlvbiBodHRwc1Byb3h5RnJvbUVudmlyb25tZW50KCk6IHN0cmluZyB8IHVuZGVmaW5lZCB7XG4gIGlmIChwcm9jZXNzLmVudi5odHRwc19wcm94eSkge1xuICAgIHJldHVybiBwcm9jZXNzLmVudi5odHRwc19wcm94eTtcbiAgfVxuICBpZiAocHJvY2Vzcy5lbnYuSFRUUFNfUFJPWFkpIHtcbiAgICByZXR1cm4gcHJvY2Vzcy5lbnYuSFRUUFNfUFJPWFk7XG4gIH1cbiAgcmV0dXJuIHVuZGVmaW5lZDtcbn1cblxuLyoqXG4gKiBSZXR1cm4gd2hldGhlciBpdCBsb29rcyBsaWtlIHdlJ2xsIGhhdmUgRUNTIGNyZWRlbnRpYWxzIGF2YWlsYWJsZVxuICovXG5mdW5jdGlvbiBoYXNFY3NDcmVkZW50aWFscygpIHtcbiAgcmV0dXJuIChBV1MuRUNTQ3JlZGVudGlhbHMucHJvdG90eXBlIGFzIGFueSkuaXNDb25maWd1cmVkRm9yRWNzQ3JlZGVudGlhbHMoKTtcbn1cblxuLyoqXG4gKiBSZXR1cm4gd2hldGhlciB3ZSdyZSBvbiBhbiBFQzIgaW5zdGFuY2VcbiAqL1xuYXN5bmMgZnVuY3Rpb24gaGFzRWMyQ3JlZGVudGlhbHMoKSB7XG4gIGRlYnVnKFwiRGV0ZXJtaW5pbmcgd2hldGhlciB3ZSdyZSBvbiBhbiBFQzIgaW5zdGFuY2UuXCIpO1xuXG4gIGxldCBpbnN0YW5jZSA9IGZhbHNlO1xuICBpZiAocHJvY2Vzcy5wbGF0Zm9ybSA9PT0gJ3dpbjMyJykge1xuICAgIC8vIGh0dHBzOi8vZG9jcy5hd3MuYW1hem9uLmNvbS9BV1NFQzIvbGF0ZXN0L1dpbmRvd3NHdWlkZS9pZGVudGlmeV9lYzJfaW5zdGFuY2VzLmh0bWxcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB1dGlsLnByb21pc2lmeShjaGlsZF9wcm9jZXNzLmV4ZWMpKCd3bWljIHBhdGggd2luMzJfY29tcHV0ZXJzeXN0ZW1wcm9kdWN0IGdldCB1dWlkJywgeyBlbmNvZGluZzogJ3V0Zi04JyB9KTtcbiAgICAvLyBvdXRwdXQgbG9va3MgbGlrZVxuICAgIC8vICBVVUlEXG4gICAgLy8gIEVDMkFFMTQ1LUQxREMtMTNCMi05NEVELTAxMjM0QUJDREVGXG4gICAgY29uc3QgbGluZXMgPSByZXN1bHQuc3Rkb3V0LnRvU3RyaW5nKCkuc3BsaXQoJ1xcbicpO1xuICAgIGluc3RhbmNlID0gbGluZXMuc29tZSh4ID0+IG1hdGNoZXNSZWdleCgvXmVjMi9pLCB4KSk7XG4gIH0gZWxzZSB7XG4gICAgLy8gaHR0cHM6Ly9kb2NzLmF3cy5hbWF6b24uY29tL0FXU0VDMi9sYXRlc3QvVXNlckd1aWRlL2lkZW50aWZ5X2VjMl9pbnN0YW5jZXMuaHRtbFxuICAgIGNvbnN0IGZpbGVzOiBBcnJheTxbc3RyaW5nLCBSZWdFeHBdPiA9IFtcbiAgICAgIC8vIFRoaXMgcmVjb2duaXplcyB0aGUgWGVuIGh5cGVydmlzb3IgYmFzZWQgaW5zdGFuY2VzIChwcmUtNXRoIGdlbilcbiAgICAgIFsnL3N5cy9oeXBlcnZpc29yL3V1aWQnLCAvXmVjMi9pXSxcblxuICAgICAgLy8gVGhpcyByZWNvZ25pemVzIHRoZSBuZXcgSHlwZXJ2aXNvciAoNXRoLWdlbiBpbnN0YW5jZXMgYW5kIGhpZ2hlcilcbiAgICAgIC8vIENhbid0IHVzZSB0aGUgYWR2ZXJ0aXNlZCBmaWxlICcvc3lzL2RldmljZXMvdmlydHVhbC9kbWkvaWQvcHJvZHVjdF91dWlkJyBiZWNhdXNlIGl0IHJlcXVpcmVzIHJvb3QgdG8gcmVhZC5cbiAgICAgIC8vIEluc3RlYWQsIHN5c192ZW5kb3IgY29udGFpbnMgc29tZXRoaW5nIGxpa2UgJ0FtYXpvbiBFQzInLlxuICAgICAgWycvc3lzL2RldmljZXMvdmlydHVhbC9kbWkvaWQvc3lzX3ZlbmRvcicsIC9lYzIvaV0sXG4gICAgXTtcbiAgICBmb3IgKGNvbnN0IFtmaWxlLCByZV0gb2YgZmlsZXMpIHtcbiAgICAgIGlmIChtYXRjaGVzUmVnZXgocmUsIGF3YWl0IHJlYWRJZlBvc3NpYmxlKGZpbGUpKSkge1xuICAgICAgICBpbnN0YW5jZSA9IHRydWU7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGRlYnVnKGluc3RhbmNlID8gJ0xvb2tzIGxpa2UgRUMyIGluc3RhbmNlLicgOiAnRG9lcyBub3QgbG9vayBsaWtlIEVDMiBpbnN0YW5jZS4nKTtcbiAgcmV0dXJuIGluc3RhbmNlO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzZXRDb25maWdWYXJpYWJsZSgpIHtcbiAgY29uc3QgaG9tZURpciA9IHByb2Nlc3MuZW52LkhPTUUgfHwgcHJvY2Vzcy5lbnYuVVNFUlBST0ZJTEVcbiAgICB8fCAocHJvY2Vzcy5lbnYuSE9NRVBBVEggPyAoKHByb2Nlc3MuZW52LkhPTUVEUklWRSB8fCAnQzovJykgKyBwcm9jZXNzLmVudi5IT01FUEFUSCkgOiBudWxsKSB8fCBvcy5ob21lZGlyKCk7XG5cbiAgaWYgKGF3YWl0IGZzLnBhdGhFeGlzdHMocGF0aC5yZXNvbHZlKGhvbWVEaXIsICcuYXdzJywgJ2NvbmZpZycpKSkge1xuICAgIHByb2Nlc3MuZW52LkFXU19TREtfTE9BRF9DT05GSUcgPSAnMSc7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gcmVhZElmUG9zc2libGUoZmlsZW5hbWU6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nIHwgdW5kZWZpbmVkPiB7XG4gIHRyeSB7XG4gICAgaWYgKCFhd2FpdCBmcy5wYXRoRXhpc3RzKGZpbGVuYW1lKSkgeyByZXR1cm4gdW5kZWZpbmVkOyB9XG4gICAgcmV0dXJuIGZzLnJlYWRGaWxlKGZpbGVuYW1lLCB7IGVuY29kaW5nOiAndXRmLTgnIH0pO1xuICB9IGNhdGNoIChlKSB7XG4gICAgZGVidWcoZSk7XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxufVxuXG5mdW5jdGlvbiBtYXRjaGVzUmVnZXgocmU6IFJlZ0V4cCwgczogc3RyaW5nIHwgdW5kZWZpbmVkKSB7XG4gIHJldHVybiBzICE9PSB1bmRlZmluZWQgJiYgcmUuZXhlYyhzKSAhPT0gbnVsbDtcbn1cbiJdfQ==